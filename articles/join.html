<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial Joins Extended • geocompkg | metapackage for the Gecomputation with R book</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spatial Joins Extended">
<meta property="og:description" content="geocompkg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geocompkg | metapackage for the Gecomputation with R book</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="https://geocompr.github.io/vignettes/">Vignettes and solutions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://geocompr.github.io/">Back to the main website</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="join_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spatial Joins Extended</h1>
                        <h4 class="author">Robin Lovelace, Jakub Nowosad, Jannes Muenchow</h4>
            
            <h4 class="date">2021-09-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Robinlovelace/geocompr/blob/master/vignettes/join.Rmd"><code>vignettes/join.Rmd</code></a></small>
      <div class="hidden name"><code>join.Rmd</code></div>

    </div>

    
    
<p>This vignette provides some further detail on the Vector attribute joining section (see <a href="https://geocompr.robinlovelace.net/attr.html#vector-attribute-joining" class="uri">https://geocompr.robinlovelace.net/attr.html#vector-attribute-joining</a> ) of <a href="https://geocompr.github.io/">the Geocomputation with R book</a>.</p>
<p>This vignette requires the following packages to be installed and attached:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://nowosad.github.io/spData/">spData</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<p>We will use an <code>sf</code> object <code>north_america</code> with country codes (<code>iso_a2</code>), names and geometries, as well as a <code>data.frame</code> object <code>wb_north_america</code> containing information about urban population and unemployment for three countries. Note that <code>north_america</code> contains data about Canada, Greenland and the United States but the World Bank dataset (<code>wb_north_america</code>) contains information about Canada, Mexico and the United States:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">north_america</span> <span class="op">=</span> <span class="va">world</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">subregion</span> <span class="op">==</span> <span class="st">"Northern America"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">iso_a2</span>, <span class="va">name_long</span><span class="op">)</span>
<span class="va">north_america</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 2 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513
## Geodetic CRS:  WGS 84
## # A tibble: 3 × 3
##   iso_a2 name_long                                                          geom
##   &lt;chr&gt;  &lt;chr&gt;                                                &lt;MULTIPOLYGON [°]&gt;
## 1 CA     Canada        (((-132.71 54.04001, -133.18 54.16998, -133.2397 53.8510…
## 2 US     United States (((-171.7317 63.78252, -171.7911 63.40585, -171.5531 63.…
## 3 GL     Greenland     (((-46.76379 82.62796, -46.9007 82.19979, -44.523 81.660…</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wb_north_america</span> <span class="op">=</span> <span class="va">worldbank_df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">name</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Canada"</span>, <span class="st">"Mexico"</span>, <span class="st">"United States"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">iso_a2</span>, <span class="va">urban_pop</span>, unemploy <span class="op">=</span> <span class="va">unemployment</span><span class="op">)</span>
<span class="va">wb_north_america</span></code></pre></div>
<pre><code>## # A tibble: 3 × 4
##   name          iso_a2 urban_pop unemploy
##   &lt;chr&gt;         &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 Canada        CA      29014612     6.91
## 2 Mexico        MX      98099040     4.81
## 3 United States US     259460378     6.17</code></pre>
<p>We will use a left join to combine the two datasets. Left joins are the most commonly used operation for adding attributes to spatial data, as they return all observations from the left object (<code>north_america</code>) and the matched observations from the right object (<code>wb_north_america</code>) in new columns. Rows in the left object without matches in the right (<code>Greenland</code> in this case) result in <code>NA</code> values.</p>
<p>To join two objects we need to specify a key. This is a variable (or a set of variables) that uniquely identifies each observation (row). The <code>by</code> argument of <strong>dplyr</strong>’s join functions lets you identify the key variable. In simple cases, a single, unique variable exist in both objects like the <code>iso_a2</code> column in our example (you may need to rename columns with identifying information for this to work):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">left_join1</span> <span class="op">=</span> <span class="va">north_america</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">wb_north_america</span>, by <span class="op">=</span> <span class="st">"iso_a2"</span><span class="op">)</span>
<span class="va">left_join1</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 5 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513
## Geodetic CRS:  WGS 84
## # A tibble: 3 × 6
##   iso_a2 name_long                                 geom name  urban_pop unemploy
##   &lt;chr&gt;  &lt;chr&gt;                       &lt;MULTIPOLYGON [°]&gt; &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 CA     Canada        (((-132.71 54.04001, -133.18 54… Cana…  29014612     6.91
## 2 US     United States (((-171.7317 63.78252, -171.791… Unit… 259460378     6.17
## 3 GL     Greenland     (((-46.76379 82.62796, -46.9007… &lt;NA&gt;         NA    NA</code></pre>
<p>This has created a spatial dataset with the new variables added. The utility of this is shown in the figure below, which shows the unemployment rate (a World Bank variable) across the countries of North America.</p>
<div class="figure">
<img src="join_files/figure-html/unemploy-1.png" alt="Figure 1. The unemployment rate (taken from World Bank statistics) in Canada and the United States to illustrate the utility of joining attribute data on to spatial datasets." width="480"><p class="caption">
Figure 1. The unemployment rate (taken from World Bank statistics) in Canada and the United States to illustrate the utility of joining attribute data on to spatial datasets.
</p>
</div>
<p>It is also possible to join objects by different variables. Both of the datasets have variables with names of countries, but they are named differently. The <code>north_america</code> has a <code>name_long</code> column and the <code>wb_north_america</code> has a <code>name</code> column. In these cases a named vector, such as <code><a href="https://rdrr.io/r/base/c.html">c("name_long" = "name")</a></code>, can specify the connection:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">left_join2</span> <span class="op">=</span> <span class="va">north_america</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">wb_north_america</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"name_long"</span> <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span><span class="op">)</span>
<span class="va">left_join2</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 5 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513
## Geodetic CRS:  WGS 84
## # A tibble: 3 × 6
##   iso_a2.x name_long                            geom iso_a2.y urban_pop unemploy
##   &lt;chr&gt;    &lt;chr&gt;                  &lt;MULTIPOLYGON [°]&gt; &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;
## 1 CA       Canada        (((-132.71 54.04001, -133.… CA        29014612     6.91
## 2 US       United States (((-171.7317 63.78252, -17… US       259460378     6.17
## 3 GL       Greenland     (((-46.76379 82.62796, -46… &lt;NA&gt;            NA    NA</code></pre>
<p>Note that the result contains two duplicated variables - <code>iso_a2.x</code> and <code>iso_a2.y</code> because both <code>x</code> and <code>y</code> objects have the column <code>iso_a2</code>. This can be solved by specifying all the keys:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">left_join3</span> <span class="op">=</span> <span class="va">north_america</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">wb_north_america</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iso_a2"</span>, <span class="st">"name_long"</span> <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span><span class="op">)</span>
<span class="va">left_join3</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 4 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -171.7911 ymin: 18.91619 xmax: -12.20855 ymax: 83.64513
## Geodetic CRS:  WGS 84
## # A tibble: 3 × 5
##   iso_a2 name_long                                       geom urban_pop unemploy
##   &lt;chr&gt;  &lt;chr&gt;                             &lt;MULTIPOLYGON [°]&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 CA     Canada        (((-132.71 54.04001, -133.18 54.16998…  29014612     6.91
## 2 US     United States (((-171.7317 63.78252, -171.7911 63.4… 259460378     6.17
## 3 GL     Greenland     (((-46.76379 82.62796, -46.9007 82.19…        NA    NA</code></pre>
<p>Joins also work when a data frame is the first argument. However, for them to work we need to drop the <code>sf</code> class.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">left_join4</span> <span class="op">=</span> <span class="va">wb_north_america</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="va">north_america</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iso_a2"</span><span class="op">)</span><span class="op">)</span>
<span class="va">left_join4</span></code></pre></div>
<pre><code>## # A tibble: 3 × 5
##   name          iso_a2 urban_pop unemploy name_long    
##   &lt;chr&gt;         &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;        
## 1 Canada        CA      29014612     6.91 Canada       
## 2 Mexico        MX      98099040     4.81 &lt;NA&gt;         
## 3 United States US     259460378     6.17 United States</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">left_join4</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "tbl_df"     "tbl"        "data.frame"</code></pre>
<p>In contrast to <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code> keeps only observations from the left object (<code>north_america</code>) where there are matching observations in the right object (<code>wb_north_america</code>). All columns from the left and right object are still kept:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">inner_join1</span> <span class="op">=</span> <span class="va">north_america</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">wb_north_america</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iso_a2"</span>, <span class="st">"name_long"</span> <span class="op">=</span> <span class="st">"name"</span><span class="op">)</span><span class="op">)</span>
<span class="va">inner_join1</span></code></pre></div>
<pre><code>## Simple feature collection with 2 features and 4 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -171.7911 ymin: 18.91619 xmax: -52.6481 ymax: 83.23324
## Geodetic CRS:  WGS 84
## # A tibble: 2 × 5
##   iso_a2 name_long                                       geom urban_pop unemploy
##   &lt;chr&gt;  &lt;chr&gt;                             &lt;MULTIPOLYGON [°]&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 CA     Canada        (((-132.71 54.04001, -133.18 54.16998…  29014612     6.91
## 2 US     United States (((-171.7317 63.78252, -171.7911 63.4… 259460378     6.17</code></pre>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robin Lovelace, Jakub Nowosad, Jannes Muenchow.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
